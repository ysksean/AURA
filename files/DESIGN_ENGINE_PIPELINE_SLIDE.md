# 디자인 엔진 내부 파이프라인 구조

---

## 슬라이드 레이아웃

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                                                                             │
│  [헤더] 디자인 엔진: LangGraph + A2A 아키텍처                                │
│                                                                             │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│  ┌─────────────────────────────┐     ┌─────────────────────────────┐       │
│  │         Before              │     │         After               │       │
│  │       (One-Shot)            │     │     (LangGraph + A2A)       │       │
│  │                             │     │                             │       │
│  │  ┌───────────────────────┐ │     │  ┌─────┐ ┌─────┐ ┌─────┐   │       │
│  │  │                       │ │     │  │분석 │ │레이아│ │타이포│   │       │
│  │  │   하나의 거대한       │ │     │  │Agent│ │Agent│ │Agent│   │       │
│  │  │   프롬프트            │ │     │  └──┬──┘ └──┬──┘ └──┬──┘   │       │
│  │  │                       │ │     │     │       │       │       │       │
│  │  │  분석+레이아웃+타이포  │ │     │     └───────┼───────┘       │       │
│  │  │  +HTML+검수           │ │     │             ▼               │       │
│  │  │                       │ │     │        ┌─────────┐          │       │
│  │  └───────────────────────┘ │     │        │  HTML   │          │       │
│  │                             │     │        │Generator│          │       │
│  │  ❌ 지시 충돌               │     │        └────┬────┘          │       │
│  │  ❌ 결과 불안정             │     │             │               │       │
│  │  ❌ 유지보수 어려움         │     │             ▼               │       │
│  │                             │     │        ┌─────────┐          │       │
│  │                             │     │        │ 품질검수 │◀─── Retry│       │
│  │                             │     │        └─────────┘          │       │
│  │                             │     │                             │       │
│  │                             │     │  ✅ 병렬 처리               │       │
│  │                             │     │  ✅ 부분 재시도             │       │
│  │                             │     │  ✅ 역할별 협상             │       │
│  └─────────────────────────────┘     └─────────────────────────────┘       │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

---

## 1. One-Shot → LangGraph 전환 이유

### 문제 상황 (One-Shot 프롬프트)

| 문제 | 설명 |
|:---|:---|
| **지시 충돌** | 분석/레이아웃/타이포/HTML/검수 지시가 한 프롬프트에 섞여 서로 충돌 |
| **결과 불안정** | 실행할 때마다 결과가 들쭉날쭉 → 재현성 저하 |
| **유지보수 어려움** | 기능 수정 시 전체 프롬프트를 뜯어고쳐야 함 |

### 해결: LangGraph 구조화

```
┌─────────────────────────────────────────────────────────────────────┐
│                                                                     │
│  [기존] 하나의 거대한 프롬프트                                       │
│  ┌─────────────────────────────────────────────────────────────┐   │
│  │  분석 + 레이아웃 + 타이포그래피 + HTML 생성 + 품질 검수       │   │
│  └─────────────────────────────────────────────────────────────┘   │
│                                                                     │
│                              ▼                                      │
│                                                                     │
│  [변경] 단계별 노드로 분리 (LangGraph)                               │
│  ┌──────────┐  ┌──────────┐  ┌──────────┐  ┌──────────┐           │
│  │   분석   │─▶│ 레이아웃  │─▶│ 타이포   │─▶│   HTML   │           │
│  └──────────┘  └──────────┘  └──────────┘  └──────────┘           │
│                                                    │                │
│                                                    ▼                │
│                                              ┌──────────┐           │
│                             Retry ◀───────── │  품질검수 │           │
│                                              └──────────┘           │
│                                                                     │
└─────────────────────────────────────────────────────────────────────┘
```

### 효과

| 항목 | 개선 내용 |
|:---|:---|
| **모듈화** | 각 단계가 독립적 → 수정 시 해당 노드만 변경 |
| **순환 루프** | 품질 검수 → 미달 시 재생성 → 품질 보장 |
| **디버깅 용이** | 어느 단계에서 문제인지 명확히 파악 |

---

## 2. A2A (Agent-to-Agent) 구조 도입 이유

### 핵심 관찰: 일부 작업은 의존성이 낮음

```
┌─────────────────────────────────────────────────────────────────────┐
│                                                                     │
│           의존성이 낮은 작업들 (병렬 처리 가능)                       │
│                                                                     │
│      ┌────────────────┐  ┌────────────────┐  ┌────────────────┐    │
│      │ 메타데이터 분석 │  │ 텍스트 후보생성 │  │ 레이아웃 후보  │    │
│      │     Agent      │  │     Agent      │  │     Agent      │    │
│      └───────┬────────┘  └───────┬────────┘  └───────┬────────┘    │
│              │                   │                   │              │
│              └───────────────────┼───────────────────┘              │
│                                  │                                  │
│                                  ▼                                  │
│                         asyncio.gather()                            │
│                          (병렬 실행)                                 │
│                                                                     │
└─────────────────────────────────────────────────────────────────────┘
```

### One-Shot vs A2A 비교

| 항목 | One-Shot | A2A (Agent-to-Agent) |
|:---|:---:|:---:|
| 처리 방식 | 순차 처리 | **병렬 처리** |
| 실패 시 | 전체 재생성 | **부분 재실행** |
| 평균 지연 | 길어짐 | **단축** |
| 캐싱 | 어려움 | **노드별 캐싱 가능** |

### 에이전트 간 협상 구조

```
┌─────────────────────────────────────────────────────────────────────┐
│                                                                     │
│   "레이아웃이 너무 복잡해서 텍스트가 안 들어가요"                      │
│                                                                     │
│      ┌──────────┐         대화         ┌──────────┐                │
│      │ 레이아웃  │ ◀─────────────────▶ │ 가독성   │                │
│      │  Agent   │    "그럼 2단→1단"    │  Agent   │                │
│      └──────────┘                      └──────────┘                │
│            │                                │                       │
│            └──────────────┬─────────────────┘                       │
│                           │                                         │
│                           ▼                                         │
│                    ┌────────────┐                                   │
│                    │  Mood      │                                   │
│                    │  Agent     │                                   │
│                    │ "색상조정" │                                   │
│                    └────────────┘                                   │
│                                                                     │
│   → 역할별 에이전트가 협상/조정하며 최적 결과 수렴                    │
│                                                                     │
└─────────────────────────────────────────────────────────────────────┘
```

---

## 3. A2A 구조 선택 이유 정리

| 관점 | 효과 |
|:---|:---|
| **속도 최적화** | 병렬 처리 (asyncio.gather) → 처리 시간 단축 |
| **안정성** | 부분 재시도 가능 → 전체 재생성 불필요 |
| **캐싱** | 노드별 결과 캐싱 → 중복 연산 방지 |
| **품질** | 역할별 에이전트 협상 → 최적 결과 수렴 |
| **유지보수** | 에이전트 단위 수정 → 영향 범위 최소화 |

---

## 발표 대본

### [LangGraph 전환 이유]
"저희 디자인 엔진의 내부 구조를 설명드리겠습니다.

처음에는 **하나의 프롬프트**로 분석, 레이아웃, 타이포그래피, HTML, 검수를 **한 번에** 시켰습니다.

하지만 기능이 늘어나면서 프롬프트가 너무 길어졌고, 세 가지 문제가 발생했습니다.
첫째, **지시가 서로 충돌**했습니다.
둘째, **결과가 들쭉날쭉**해져 재현성이 떨어졌습니다.
셋째, **수정할 때 전체 프롬프트**를 다시 뜯어고쳐야 했습니다.

그래서 긴 프롬프트를 **단계별 노드로 분리**하고, **LangGraph**로 구조화했습니다.
또한 **순환 루프**를 통해 품질이 기준에 미달하면 재생성하도록 했습니다."

---

### [A2A 구조 도입 이유]
"여기서 한 단계 더 나아가, **A2A(Agent-to-Agent) 구조**를 도입했습니다.

디자인 엔진 내부 작업 중 일부는 **서로 의존성이 낮습니다**.
예를 들어, 메타데이터 분석, 텍스트 후보 생성, 레이아웃 후보 생성은 **동시에 실행**할 수 있습니다.

그래서 각 노드를 **에이전트로 만들고**, `asyncio.gather`로 **병렬 처리**했습니다.

One-Shot 방식은 실패 시 **전체 재생성**이 필요해 평균 지연이 컸지만,
A2A 구조는 **부분 재실행**이 가능해 평균 처리 시간이 감소합니다.

또한 레이아웃, 가독성, 무드처럼 **역할별 에이전트가 협상**하면서 
최적의 결과로 수렴하는 구조를 만들어 **품질도 향상**시켰습니다.

정리하면, **병렬화, 부분 재시도, 캐싱**이 가능한 구조와 **품질 개선**을 위해
디자인 엔진을 **A2A 구조**로 설계했습니다."
