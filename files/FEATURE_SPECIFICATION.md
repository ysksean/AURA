# 기능 정의서 (SW)

---

## 문서 정보

| 항목 | 내용 |
|:---|:---|
| **프로젝트 명** | AI Magazine Layout Generator |
| **문서 업데이트** | 2026.01.19 |
| **작성자** | 유신, 규리, 명래, 승민 |

---

## 기능 목록

| 구분 | 메뉴 | 기능 설명 |
|:---|:---|:---|
| **USER** | 홈 | 메인 페이지 접속, 서비스 소개 및 시작하기 |
| | 콘텐츠 입력 | 이미지 업로드 (1~7장), 제목/소제목/본문 입력 |
| | 레이아웃 타입 선택 | Cover/Article 타입 선택 |
| | Mood 선택 | Elegant, Vibrant, Bold, Luxurious 등 분위기 선택 |
| | 레이아웃 생성 | AI 기반 잡지 레이아웃 자동 생성 요청 |
| | 결과 미리보기 | 생성된 레이아웃 실시간 미리보기 |
| | 결과 다운로드 | HTML/PNG/PDF 형식으로 다운로드 |
| | 토글 기능 | AI 생성/보존 모드 토글 선택 |
| | 히스토리 | 이전 생성 결과 조회 |
| **Guest** | 홈 | 비회원 전용 메인 화면 접속 |
| | 서비스 소개 | 서비스 개요, 기능 안내, 생성 예시 확인 |
| | 데모 체험 | 샘플 이미지/텍스트로 제한된 레이아웃 생성 체험 |
| **SYSTEM** | **LangGraph 파이프라인** | MCP Server 기반 8노드 멀티 에이전트 |
| | ① Intent Classifier | 사용자 입력 의도 분류 (Guard 노드) |
| | | 잡지 관련 요청 여부 판단 |
| | ② Content Filter | 콘텐츠 안전성 필터링 (Guard 노드) |
| | | 부적절한 콘텐츠/PII 탐지, Hybrid Detection |
| | ③ Image Analyzer | 이미지 분석 및 HERO 이미지 결정 |
| | | 공간 분석, 색상 추출, 피사체 위치 추적 |
| | ④ Layout Planner | 페이지 그리드 구조 결정 |
| | | RAG 검색 연동, 레이아웃 후보 생성 |
| | ⑤ Typography Styler | 폰트/색상/강조 스타일 결정 |
| | | Mood 기반 스타일 추론, Google Fonts 적용 |
| | ⑥ HTML Generator | 최종 HTML 코드 생성 |
| | | Placeholder 치환, 다중 이미지 배치 |
| | ⑦ Validator | 생성된 HTML 구조 검증 |
| | | DOM 유효성, 필수 요소 존재 확인 |
| | ⑧ HTML Quality Checker | HTML 품질 검수 (Critique) |
| | | 품질 점수 산출, 동적 재시도 결정 |
| | **Quality Router** | 품질 기반 라우팅 |
| | | 85점 ↑: Pass / 85점 ↓: Retry (Max 5) |
| | **RAG System** | 벡터 DB 기반 레이아웃 검색 |
| | - Voyage 3.5 임베딩 | 512차원, MRL 적용 |
| | - Dense Only 검색 | Dot Product (내적) 유사도 |
| | - Index Caching | 초기화 20배 향상 |
| | - 4-Stage Fallback | 검색 성공률 100% |
| | **Image Processing** | 이미지 전처리 및 최적화 |
| | - object-fit 조정 | 피사체 잘림 방지 |
| | - Base64 인코딩 | 이미지 데이터 직렬화 |
| | - 용량 최적화 | max_width=1024, quality=75 |
| **ADMIN** | 데이터 관리 | 레이아웃 DB 관리 (122개 레이아웃) |
| | 템플릿 관리 | Template Registry (104개 테마) |
| | 벡터 DB 관리 | ChromaDB 인덱스 관리 |
| | 모니터링 | 생성 요청 현황, 성공률, 품질 점수 통계 |
| | 로그 관리 | 에이전트 간 데이터 흐름 추적 |

---

## 상세 기능 정의

---

### F01. 콘텐츠 입력

#### 기능 정의
> **사용자는 이미지와 텍스트를 입력하여 AI 잡지 레이아웃을 생성할 수 있다.**

#### 사용자 시나리오
1. 사용자는 홈페이지에서 **"레이아웃 생성"** 버튼을 클릭한다.
2. 이미지 업로드 영역에 **1~7장의 이미지**를 드래그 앤 드롭 또는 파일 선택으로 업로드한다.
3. **제목, 소제목, 본문** 텍스트를 각 입력 필드에 작성한다.
4. **레이아웃 타입**(Cover/Article)을 선택한다.
5. **Mood**(Elegant, Vibrant, Bold 등)를 선택한다.
6. **"생성하기"** 버튼을 클릭하면 AI가 레이아웃을 생성한다.
7. 생성이 완료되면 결과 미리보기 화면으로 이동한다.

#### 화면 설계

```
┌─────────────────────────────────────────────────────────────────────┐
│  [로고]                                          [히스토리] [설정]  │
├─────────────────────────────────────────────────────────────────────┤
│                                                                     │
│  ┌──────────────────────────────────────────────────────────────┐  │
│  │                    📷 이미지 업로드                           │  │
│  │                                                              │  │
│  │     [이미지 드래그 앤 드롭 또는 클릭하여 업로드]              │  │
│  │                   (최대 7장, PNG/JPG/WEBP)                   │  │
│  │                                                              │  │
│  └──────────────────────────────────────────────────────────────┘  │
│                                                                     │
│  ┌──────────────────────────────────────────────────────────────┐  │
│  │  제목                                                        │  │
│  │  ┌──────────────────────────────────────────────────────┐   │  │
│  │  │                                                      │   │  │
│  │  └──────────────────────────────────────────────────────┘   │  │
│  │                                                              │  │
│  │  소제목                                                      │  │
│  │  ┌──────────────────────────────────────────────────────┐   │  │
│  │  │                                                      │   │  │
│  │  └──────────────────────────────────────────────────────┘   │  │
│  │                                                              │  │
│  │  본문                                                        │  │
│  │  ┌──────────────────────────────────────────────────────┐   │  │
│  │  │                                                      │   │  │
│  │  │                                                      │   │  │
│  │  └──────────────────────────────────────────────────────┘   │  │
│  └──────────────────────────────────────────────────────────────┘  │
│                                                                     │
│  레이아웃 타입                    Mood                             │
│  ┌─────────────────────┐        ┌─────────────────────┐           │
│  │ ○ Cover  ● Article │        │ Elegant         ▼   │           │
│  └─────────────────────┘        └─────────────────────┘           │
│                                                                     │
│           ┌────────────────────────────────────┐                   │
│           │         🚀 레이아웃 생성하기         │                   │
│           └────────────────────────────────────┘                   │
│                                                                     │
└─────────────────────────────────────────────────────────────────────┘
```

#### 입력값/출력값 정의

| 구분 | 필드명 | 타입 | 필수 | 설명 | 제약조건 |
|:---:|:---|:---:|:---:|:---|:---|
| **입력** | images | File[] | O | 업로드 이미지 | 1~7장, PNG/JPG/WEBP, 최대 10MB/장 |
| | title | String | O | 제목 | 최대 100자 |
| | subtitle | String | X | 소제목 | 최대 200자 |
| | body | String | O | 본문 | 최대 5000자 |
| | layout_type | Enum | O | 레이아웃 타입 | "cover" \| "article" |
| | mood | Enum | O | 분위기 | "elegant" \| "vibrant" \| "bold" \| ... |
| **출력** | layout_id | String | - | 생성된 레이아웃 ID | UUID |
| | html_output | String | - | 생성된 HTML 코드 | - |
| | preview_url | String | - | 미리보기 URL | - |

#### 예외 처리

| 예외 상황 | 에러 메시지 | 처리 방법 |
|:---|:---|:---|
| 이미지 미업로드 | "이미지를 1장 이상 업로드해주세요." | 업로드 영역 강조 표시 |
| 이미지 초과 (8장+) | "이미지는 최대 7장까지 업로드할 수 있습니다." | 추가 업로드 차단 |
| 이미지 형식 오류 | "지원하지 않는 파일 형식입니다. (PNG, JPG, WEBP만 가능)" | 파일 선택 무시 |
| 이미지 용량 초과 | "이미지 크기는 10MB 이하여야 합니다." | 파일 선택 무시 |
| 제목 미입력 | "제목을 입력해주세요." | 입력 필드 강조 |
| 본문 미입력 | "본문을 입력해주세요." | 입력 필드 강조 |
| 서버 오류 | "일시적인 오류가 발생했습니다. 잠시 후 다시 시도해주세요." | 재시도 버튼 표시 |

---

### F02. Vision 분석

#### 기능 정의
> **시스템은 업로드된 이미지를 분석하여 공간, 색상, 피사체 정보를 추출한다.**

#### 데이터 흐름

```
┌─────────────┐       ┌─────────────────┐       ┌─────────────────┐
│   이미지    │ ────▶ │  Vision Agent   │ ────▶ │   분석 결과     │
│   (Base64)  │       │  (Gemini Vision)│       │   (JSON)        │
└─────────────┘       └─────────────────┘       └─────────────────┘
```

#### 입력값/출력값 정의

| 구분 | 필드명 | 타입 | 설명 |
|:---:|:---|:---:|:---|
| **입력** | image_data | Base64[] | 이미지 데이터 리스트 |
| **출력** | safe_areas | Object[] | 텍스트 배치 가능 영역 좌표 |
| | dominant_colors | String[] | 주요 색상 (Hex 코드) |
| | dominant_position | String | 피사체 위치 (center, left, right) |
| | content_type | String | 콘텐츠 유형 (fashion, beauty, food 등) |
| | layout_scores | Object | 레이아웃별 추천 점수 |

#### 예외 처리

| 예외 상황 | 에러 메시지 | 처리 방법 |
|:---|:---|:---|
| 이미지 손상 | "이미지를 분석할 수 없습니다." | 기본 분석 결과 반환 |
| API 타임아웃 | "분석 시간이 초과되었습니다." | 3회 재시도 후 실패 처리 |
| 지원하지 않는 형식 | "이미지 형식을 확인해주세요." | 에러 로그 기록 |

---

### F03. RAG 검색

#### 기능 정의
> **시스템은 벡터 DB에서 사용자 입력과 가장 유사한 레이아웃을 검색한다.**

#### 데이터 흐름

```
┌─────────────┐       ┌─────────────────┐       ┌─────────────────┐
│  쿼리 생성   │ ────▶ │  Voyage 3.5     │ ────▶ │  벡터 임베딩    │
│  (분석결과)  │       │  Embedding      │       │  (512D)         │
└─────────────┘       └─────────────────┘       └─────────────────┘
                                                        │
                                                        ▼
┌─────────────┐       ┌─────────────────┐       ┌─────────────────┐
│  검색 결과   │ ◀──── │  ChromaDB       │ ◀──── │  유사도 검색    │
│  (Top 3)    │       │  Vector Search  │       │  (Dot Product)  │
└─────────────┘       └─────────────────┘       └─────────────────┘
```

#### 입력값/출력값 정의

| 구분 | 필드명 | 타입 | 설명 |
|:---:|:---|:---:|:---|
| **입력** | query | String | 검색 쿼리 (mood + category + description) |
| | filters | Object | 필터 조건 (type, image_count, layout_ratio) |
| | top_k | Integer | 반환할 결과 수 (기본값: 3) |
| **출력** | recommendations | Object[] | 추천 레이아웃 목록 |
| | - image_id | String | 레이아웃 ID |
| | - score | Float | 유사도 점수 |
| | - metadata | Object | 레이아웃 메타데이터 |

#### Fallback 전략

| Stage | 조건 | 설명 |
|:---:|:---|:---|
| **Stage 1** | type + image_count + layout_ratio | 모든 조건 일치 |
| **Stage 2** | type + image_count | 비율 조건 완화 |
| **Stage 3** | type only | 이미지 개수 조건 완화 |
| **Stage 4** | 조건 없음 | 최후 수단 (이미지 개수만 유지) |

#### 예외 처리

| 예외 상황 | 에러 메시지 | 처리 방법 |
|:---|:---|:---|
| 검색 결과 없음 | - | Fallback Stage 진행 |
| API 연결 실패 | "검색 서비스에 연결할 수 없습니다." | 캐시된 결과 반환 또는 재시도 |
| 타임아웃 | "검색 시간이 초과되었습니다." | 3회 재시도 |

---

### F04. MCP 렌더링

#### 기능 정의
> **시스템은 MCP Server를 통해 최종 HTML 레이아웃을 생성하고 품질을 검수한다.**

#### LangGraph 파이프라인 (8노드)

```
┌───────────┐   ┌───────────┐   ┌───────────┐   ┌───────────┐
│  Intent   │──▶│  Content  │──▶│   Image   │──▶│  Layout   │
│ Classifier│   │  Filter   │   │ Analyzer  │   │  Planner  │
│ (Guard 1) │   │ (Guard 2) │   │           │   │           │
└───────────┘   └───────────┘   └───────────┘   └───────────┘
                                                      │
                                                      ▼
┌───────────┐   ┌───────────┐   ┌───────────┐   ┌───────────┐
│   END     │◀──│ Quality   │◀──│ Validator │◀──│Typography │
│           │   │  Router   │   │           │   │  Styler   │
└───────────┘   └───────────┘   └───────────┘   └───────────┘
      ▲               │                               │
      │               │ Score < 85                    ▼
      │               ▼                         ┌───────────┐
      │         ┌───────────┐                   │   HTML    │
      └─────────│  Retry    │                   │ Generator │
                │  (Max 5)  │◀──────────────────└───────────┘
                └───────────┘
```

#### 입력값/출력값 정의

| 구분 | 필드명 | 타입 | 설명 |
|:---:|:---|:---:|:---|
| **입력** | headline | String | 제목 |
| | body | String | 본문 |
| | image_data | String | 이미지 플레이스홀더 |
| | layout_override | String | 레이아웃 지정 (옵션) |
| | vision_context | Object | Vision 분석 결과 |
| | design_spec | Object | 디자인 스펙 |
| **출력** | html_output | String | 생성된 HTML 코드 |
| | quality_score | Integer | 품질 점수 (0~100) |
| | validation_result | Object | 검수 결과 상세 |

#### 품질 기준

| 점수 | 동작 |
|:---:|:---|
| **85점 이상** | 즉시 통과 (Pass) |
| **70~84점** | 최대 2회 재시도 후 통과 |
| **70점 미만** | 최대 5회 재시도 |

#### 예외 처리

| 예외 상황 | 에러 메시지 | 처리 방법 |
|:---|:---|:---|
| 생성 실패 | "레이아웃 생성에 실패했습니다." | 기본 템플릿으로 대체 |
| 타임아웃 (300초) | "생성 시간이 초과되었습니다." | 부분 결과 반환 |
| 품질 미달 (5회 후) | - | 최고 점수 결과 반환 |

---

### F05. Safety 필터

#### 기능 정의
> **시스템은 부적절한 콘텐츠를 자동으로 필터링하고 PII(개인정보)를 탐지한다.**

#### 데이터 흐름

```
┌─────────────┐       ┌─────────────────┐       ┌─────────────────┐
│  사용자 입력 │ ────▶ │   Regex 탐지    │ ────▶ │   1차 필터링    │
│  (텍스트)   │       │   (이메일 등)   │       │                 │
└─────────────┘       └─────────────────┘       └─────────────────┘
                                                        │
                                                        ▼
┌─────────────┐       ┌─────────────────┐       ┌─────────────────┐
│  최종 판정   │ ◀──── │   결과 병합     │ ◀──── │   LLM 분석     │
│  (SAFE/     │       │  (Hybrid)       │       │  (Pydantic)    │
│   UNSAFE)   │       └─────────────────┘       └─────────────────┘
└─────────────┘
```

#### 입력값/출력값 정의

| 구분 | 필드명 | 타입 | 설명 |
|:---:|:---|:---:|:---|
| **입력** | text | String | 검사할 텍스트 |
| **출력** | is_safe | Boolean | 안전 여부 |
| | reason | String | 차단 사유 (불안전 시) |
| | pii_detected | String[] | 탐지된 개인정보 종류 |

#### ALLOW 리스트 (오탐 방지)

| 항목 | 설명 |
|:---|:---|
| 인터뷰이 이름 | 기사 내 인물 이름 허용 |
| 브랜드명 | 상업적 브랜드 언급 허용 |
| 예술적 묘사 | 수영복, 화보 등 허용 |

#### 예외 처리

| 예외 상황 | 에러 메시지 | 처리 방법 |
|:---|:---|:---|
| LLM 응답 오류 | - | 기본값 UNSAFE 처리 (보안 우선) |
| 판단 불가 | - | 수동 검토 대기열 추가 |

---

### F06. 결과 다운로드

#### 기능 정의
> **사용자는 생성된 레이아웃을 HTML 또는 이미지 파일로 다운로드할 수 있다.**

#### 사용자 시나리오
1. 사용자는 생성된 레이아웃 미리보기 화면에서 **"다운로드"** 버튼을 클릭한다.
2. 다운로드 형식 선택 팝업이 나타난다.
3. **HTML** 또는 **PNG/PDF** 형식을 선택한다.
4. 파일이 자동으로 다운로드된다.

#### 입력값/출력값 정의

| 구분 | 필드명 | 타입 | 설명 |
|:---:|:---|:---:|:---|
| **입력** | layout_id | String | 레이아웃 ID |
| | format | Enum | "html" \| "png" \| "pdf" |
| **출력** | file | Blob | 다운로드 파일 |
| | filename | String | 파일명 |

---

## API 연동 정보

| API | 제공사 | 용도 | 비고 |
|:---|:---|:---|:---|
| **Gemini API** | Google | 이미지 분석, 텍스트 생성 | 2.5 Flash/Pro |
| **Voyage AI** | Voyage | 텍스트 임베딩 | 3.5 모델, 512차원 |
| **ChromaDB** | - | 벡터 저장/검색 | 로컬 DB |
| **Serper API** | Serper | 트렌드 검색 | (선택적) |

---

## 성능 요구사항

| 항목 | 목표 | 비고 |
|:---|:---:|:---|
| 레이아웃 생성 시간 | 25초 이내 | 이미지 1장 기준 |
| 검색 응답 시간 | 0.5초 이내 | Index Caching 적용 |
| 품질 점수 | 90점 이상 | 평균 |
| 가용성 | 99.5% | - |
