# 서비스 고도화 방향 (3대 핵심 영역)

---

## 1. 데이터 확장 (Data Scaling)

### 현재 상태
| 항목 | 값 |
|:---|:---|
| 데이터셋 | `datas/final_final_dataset.json` |
| 레이아웃 수 | **52개** |
| 유형 | Cover (13개), Article (39개) |
| Category | 10개 (fashion, beauty, lifestyle 등) |
| Mood | 10종 (Elegant, Luxurious, Vibrant 등) |
| 요소 평균 | 10.7개/레이아웃 |

### 문제점
1. **데이터 다양성 부족**: 52개로는 다양한 디자인 요구 대응 한계
2. **카테고리 편중**: fashion/beauty 위주, 스포츠/여행/인테리어 부족
3. **수동 라벨링**: 확장 시 인력/시간 비용 증가

---

### 고도화 방향

#### 1-1. 목표 데이터 규모
| 항목 | 현재 | 1차 목표 | 최종 목표 |
|:---:|:---:|:---:|:---:|
| 레이아웃 수 | 52개 | **200개** | **1000개+** |
| Category | 10개 | **15개** | **25개** |
| Mood | 10종 | **15종** | **30종** |
| Cover:Article 비율 | 1:3 | 1:3 | 1:4 |

#### 1-2. 자동화 파이프라인

```
┌─────────────────────────────────────────────────────────────────┐
│  Phase 1: 데이터 수집                                            │
│  매거진 PDF → 페이지 분리 → 이미지 추출                           │
├─────────────────────────────────────────────────────────────────┤
│  Phase 2: 레이아웃 분석                                          │
│  페이지 이미지 → Gemini Vision 분석 → 요소 좌표 JSON 생성         │
├─────────────────────────────────────────────────────────────────┤
│  Phase 3: 메타데이터 라벨링                                       │
│  레이아웃 JSON → Gemini 자동 라벨링 → Mood/Category 자동 태깅      │
├─────────────────────────────────────────────────────────────────┤
│  Phase 4: 품질 검증                                              │
│  라벨링 결과 → 자동 검증 (중복/품질) → 최종 데이터셋               │
└─────────────────────────────────────────────────────────────────┘
```

#### 1-3. 예상 일정
| 단계 | 작업 | 기간 |
|:---:|:---|:---:|
| 1 | PDF 파싱 스크립트 개발 | 3일 |
| 2 | Gemini 자동 라벨링 프롬프트 최적화 | 2일 |
| 3 | 품질 검증 스크립트 개발 | 2일 |
| 4 | 100개 레이아웃 수집 | 1주 |
| 5 | 200개 달성 | 2주 |

---

## 2. RAG 시스템 고도화

### 현재 상태
| 항목 | 값 |
|:---|:---|
| 모듈 | `rag_voyage.py` |
| 임베딩 모델 | Voyage 3.5 (512차원, MRL) |
| 벡터 DB | ChromaDB (로컬 저장) |
| 검색 방식 | Dense Only (Dot Product) |
| 캐싱 | 파일 기반 (pkl) |
| 필터링 | Cascading Fallback |

### 문제점
1. **확장성 한계**: ChromaDB는 대규모 데이터에서 성능 저하
2. **캐싱 비효율**: 파일 기반 캐싱은 서버 재시작 시 메모리 재로딩
3. **단일 모달**: 텍스트 기반 검색만 지원, 이미지 검색 불가
4. **Sparse Search 미활용**: Dense Only로 키워드 매칭 약함

---

### 고도화 방향

#### 2-1. 벡터 DB 마이그레이션

| 항목 | ChromaDB (현재) | Milvus/Qdrant (고도화) |
|:---|:---:|:---:|
| 데이터 규모 | ~1000개 | **100만개+** |
| 분산 처리 | ❌ | ✅ |
| 샤딩 | ❌ | ✅ |
| 클라우드 지원 | 제한적 | 완전 지원 |
| GPU 가속 | ❌ | ✅ |

#### 2-2. Redis 캐싱 레이어

```
                              ┌─────────────┐
                              │    Query    │
                              └──────┬──────┘
                                     │
                                     ▼
                          ┌────────────────────┐
                          │   Redis 캐시 확인   │
                          └─────────┬──────────┘
                                    │
                    ┌───────────────┴───────────────┐
                    │                               │
               Cache HIT                       Cache MISS
                    │                               │
                    ▼                               ▼
          ┌─────────────────┐            ┌─────────────────┐
          │   즉시 반환      │            │  Voyage 임베딩   │
          │   (50ms)        │            │  생성            │
          └─────────────────┘            └────────┬────────┘
                                                  │
                                                  ▼
                                        ┌─────────────────┐
                                        │  Qdrant 검색    │
                                        │  (벡터 유사도)   │
                                        └────────┬────────┘
                                                 │
                                                 ▼
                                        ┌─────────────────┐
                                        │  Redis 캐시     │
                                        │  저장 (TTL 1h)  │
                                        └────────┬────────┘
                                                 │
                                                 ▼
                                        ┌─────────────────┐
                                        │   결과 반환     │
                                        │   (500ms)       │
                                        └─────────────────┘
```

- **캐시 TTL**: 1시간
- **기대 효과**: Latency 500ms → **50ms** (Cache HIT 시)

#### 2-3. 멀티모달 검색 (이미지 → 레이아웃)

| 항목 | 현재 | 고도화 |
|:---|:---:|:---:|
| 입력 | 텍스트만 | **텍스트 + 이미지** |
| 모델 | Voyage 3.5 | **Voyage Multimodal** |
| 사용 사례 | 키워드 검색 | **참조 이미지로 유사 레이아웃 검색** |

#### 2-4. 하이브리드 검색 재도입

- **Dense 검색**: Voyage 임베딩 (의미 기반)
- **Sparse 검색**: BM25 (키워드 기반)
- **RRF Fusion**: 두 결과를 결합하여 정확도 향상

#### 2-5. 예상 일정
| 단계 | 작업 | 기간 |
|:---:|:---|:---:|
| 1 | Redis 캐싱 레이어 추가 | 3일 |
| 2 | Qdrant 마이그레이션 (선택) | 1주 |
| 3 | 멀티모달 검색 연동 | 1주 |
| 4 | 하이브리드 검색 재도입 | 3일 |

---

## 3. HTML 생성 품질 고도화

### 현재 상태
| 항목 | 값 |
|:---|:---|
| 모듈 | `mcp_server_langgraph.py` |
| 노드 수 | 6개 (+ Guard 2개) |
| 품질 검수 | `html_quality_checker_node` (LLM 기반) |
| 재시도 | 최대 3회 (Retry Loop) |
| 검증 항목 | 패딩/마진, 이미지 크기, 텍스트 크기, 오버플로우 |

### 문제점
1. **LLM 기반 검수 한계**: 실제 렌더링 결과와 괴리
2. **고정 재시도**: 품질과 무관하게 3회 제한
3. **오류 패턴 학습 없음**: 반복 오류에 대한 개선 없음
4. **템플릿 부재**: 매번 처음부터 생성

---

### 고도화 방향

#### 3-1. 실제 렌더링 기반 검수

| 항목 | 현재 (LLM) | 고도화 (Vision) |
|:---|:---:|:---:|
| 입력 | HTML 코드 | **실제 렌더링 스크린샷** |
| 분석 | 텍스트 기반 추론 | **시각적 분석** |
| 정확도 | 70% | **95%+** |

```
현재: HTML 코드 → LLM 분석 → PASS/FAIL

고도화: HTML → Puppeteer 렌더링 → 스크린샷 → Vision 분석 → PASS/FAIL
```

#### 3-2. 품질 점수 기반 동적 재시도

| 점수 | 동작 |
|:---:|:---|
| **85점 이상** | 즉시 종료 (Pass) |
| **70~84점** | 2회까지 재시도 후 종료 |
| **70점 미만** | 최대 5회 재시도 |

#### 3-3. 오류 패턴 학습 및 피드백 루프

- **빈번한 오류 패턴 추적**: overflow, image_issues, text_issues, margin_issues
- **프롬프트 자동 개선**: 빈번한 오류에 대한 회피 지시 추가

#### 3-4. 검증된 템플릿 라이브러리

- 품질 점수 90점 이상 HTML 저장
- 유사 레이아웃 요청 시 참조용으로 제공

#### 3-5. Vision Agent + 병렬 검수 노드 아키텍처 (⭐ 핵심)

**핵심 아이디어**: Vision을 Agent화하여 두뇌로 두고, 각 검수 항목을 개별 노드로 분리하여 **병렬 처리**

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                                                                             │
│  HTML Generator → Puppeteer Render → Screenshot (PNG)                       │
│                                            │                                │
│                                            ▼                                │
│                     ┌─────────────────────────────────────┐                 │
│                     │      🧠 Vision Agent (두뇌)          │                 │
│                     │  Screenshot를 4개 검수 노드에 분배   │                 │
│                     │  각 노드의 결과를 종합하여 최종 판정  │                 │
│                     └──────────────────┬──────────────────┘                 │
│                                        │                                    │
│              ┌─────────────────────────┼─────────────────────────┐          │
│              │                         │                         │          │
│              ▼                         ▼                         ▼          │
│  ┌───────────────────┐   ┌───────────────────┐   ┌───────────────────┐     │
│  │ Overflow Checker  │   │ Image Checker     │   │ Text Checker      │     │
│  │                   │   │                   │   │                   │     │
│  │ 콘텐츠가 페이지   │   │ 이미지 잘림/비율  │   │ 텍스트 크기/      │     │
│  │ 밖으로 넘치는가?  │   │ 왜곡 확인         │   │ 가독성 확인        │     │
│  └─────────┬─────────┘   └─────────┬─────────┘   └─────────┬─────────┘     │
│            │                       │                       │                │
│            │     ┌───────────────────┐                     │                │
│            │     │ Margin Checker    │                     │                │
│            │     │ 여백 균형/정렬    │                     │                │
│            │     └─────────┬─────────┘                     │                │
│            │               │                               │                │
│            └───────────────┼───────────────────────────────┘                │
│                            ▼                                                │
│              ┌─────────────────────────────┐                                │
│              │      Score Aggregator       │                                │
│              │                             │                                │
│              │  overflow + image + text    │                                │
│              │  + margin = quality_score   │                                │
│              └──────────────┬──────────────┘                                │
│                             │                                               │
│                             ▼                                               │
│                   ┌──────────────────┐                                      │
│                   │ Score >= 85?     │                                      │
│                   │ ├─ YES → END     │                                      │
│                   │ └─ NO → Retry    │                                      │
│                   └──────────────────┘                                      │
└─────────────────────────────────────────────────────────────────────────────┘
```

**병렬 처리 장점**

| 항목 | 순차 처리 | 병렬 처리 |
|:---|:---:|:---:|
| 검수 시간 | 4초 (1초 × 4) | **1.2초** |
| 각 검사 정밀도 | 하나의 프롬프트에 모든 검사 | **전문화된 개별 프롬프트** |
| 확장성 | 프롬프트 복잡도 증가 | **노드 추가만 하면 됨** |
| 디버깅 | 어떤 검사가 실패했는지 불명확 | **개별 노드별 결과 추적** |

#### 3-6. 예상 일정
| 단계 | 작업 | 기간 |
|:---:|:---|:---:|
| 1 | Playwright 렌더링 검수 구현 | 3일 |
| 2 | Vision Agent + 병렬 노드 구현 | 3일 |
| 3 | 동적 재시도 로직 수정 | 1일 |
| 4 | 오류 패턴 추적 시스템 | 2일 |
| 5 | 템플릿 라이브러리 구축 | 3일 |

---

## 종합 로드맵

| 주차 | 영역 | 작업 |
|:---:|:---|:---|
| **1주** | 데이터 | PDF 파싱 + 자동 라벨링 스크립트 |
| **2주** | 데이터 | 100개 → 200개 레이아웃 확보 |
| **2주** | RAG | Redis 캐싱 레이어 추가 |
| **3주** | HTML | Playwright + Vision Agent 구현 |
| **3주** | RAG | 멀티모달 검색 연동 |
| **4주** | HTML | 동적 재시도 + 오류 패턴 학습 |
| **4주** | RAG | 하이브리드 검색 재도입 |

---

## 기대 효과

| 지표 | 현재 | 고도화 후 |
|:---|:---:|:---:|
| 레이아웃 수 | 52개 | **200개+** |
| 검색 정확도 | 80% | **95%+** |
| 검색 속도 (캐시 HIT) | 500ms | **50ms** |
| HTML 품질 점수 | 75점 | **90점+** |
| 품질 검수 시간 | 4초 | **1.2초** |
| 재시도 평균 횟수 | 2.5회 | **1.2회** |
