# RAG Fallback Strategy

---

## 슬라이드 디자인 (4단계 Fallback)

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                                                                             │
│                       🔍 RAG 4-Stage Fallback Strategy                      │
│                                                                             │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│   ┌─────────────────────────────────────────────────────────────────────┐  │
│   │                          검색 요청 시작                              │  │
│   └───────────────────────────────┬─────────────────────────────────────┘  │
│                                   │                                         │
│                                   ▼                                         │
│   ┌─────────────────────────────────────────────────────────────────────┐  │
│   │  Stage 1: 모든 필터 적용                                             │  │
│   │  ─────────────────────────────────────────────────────────────       │  │
│   │  • type (Cover/Article)                                              │  │
│   │  • image_count (1~7)                                                 │  │
│   │  • layout_ratio (Horizontal/Vertical/Square)                         │  │
│   └───────────────────────────────┬─────────────────────────────────────┘  │
│                                   │                                         │
│                          결과 있음? ─── Yes ──▶ ✅ 반환                     │
│                                   │ No                                      │
│                                   ▼                                         │
│   ┌─────────────────────────────────────────────────────────────────────┐  │
│   │  Stage 2: 비율 조건 완화                                             │  │
│   │  ─────────────────────────────────────────────────────────────       │  │
│   │  • type (Cover/Article)                                              │  │
│   │  • image_count (1~7)                                                 │  │
│   │  • ❌ layout_ratio 제외                                              │  │
│   └───────────────────────────────┬─────────────────────────────────────┘  │
│                                   │                                         │
│                          결과 있음? ─── Yes ──▶ ✅ 반환                     │
│                                   │ No                                      │
│                                   ▼                                         │
│   ┌─────────────────────────────────────────────────────────────────────┐  │
│   │  Stage 3: 이미지 개수 조건 완화                                      │  │
│   │  ─────────────────────────────────────────────────────────────       │  │
│   │  • type (Cover/Article)                                              │  │
│   │  • ❌ image_count 제외                                               │  │
│   │  • ❌ layout_ratio 제외                                              │  │
│   └───────────────────────────────┬─────────────────────────────────────┘  │
│                                   │                                         │
│                          결과 있음? ─── Yes ──▶ ✅ 반환                     │
│                                   │ No                                      │
│                                   ▼                                         │
│   ┌─────────────────────────────────────────────────────────────────────┐  │
│   │  Stage 4: 필터 없음 (최후 수단)                                      │  │
│   │  ─────────────────────────────────────────────────────────────       │  │
│   │  • ❌ 모든 필터 제외                                                 │  │
│   │  • 순수 의미 유사도만으로 검색                                       │  │
│   └───────────────────────────────┬─────────────────────────────────────┘  │
│                                   │                                         │
│                                   ▼                                         │
│                              ✅ 결과 반환                                   │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

---

## 단계별 필터 조건 요약

| Stage | 필터 조건 | 설명 |
|:---:|:---|:---|
| **1** | type + image_count + layout_ratio | 모든 조건 일치 |
| **2** | type + image_count | 비율 조건 완화 |
| **3** | type only | 이미지 개수 조건 완화 |
| **4** | (없음) | 최후 수단 - 의미 유사도만 |

---

## 발표 대본 (약 40초)

---

> **"RAG 검색의 4단계 Fallback 전략입니다.**
> 
> ---
> 
> **Stage 1**에서는 모든 필터를 적용합니다.
> 
> 레이아웃 타입, 이미지 개수, 가로세로 비율까지 전부 일치하는 결과를 찾습니다.
> 
> ---
> 
> 결과가 없으면 **Stage 2**로 넘어갑니다.
> 
> 비율 조건을 제외하고 타입과 이미지 개수만 맞춰 검색합니다.
> 
> ---
> 
> 그래도 없으면 **Stage 3**.
> 
> 이미지 개수도 제외하고 타입만 필터링합니다.
> 
> ---
> 
> 최후의 수단인 **Stage 4**는 필터 없이,
> 
> **순수 의미 유사도만으로** 가장 비슷한 레이아웃을 반환합니다.
> 
> ---
> 
> 이 전략으로 **검색 성공률 100%**를 달성했습니다."

---

## 코드 스니펫 (main.py)

```python
# 4단계 Fallback 필터 시도
filter_attempts = [
    full_filters,                                      # Stage 1: 모든 필터
    {'type': db_type, 'image_count': image_count},     # Stage 2: 비율 제외
    {'type': db_type},                                 # Stage 3: 타입만
    {}                                                 # Stage 4: 필터 없음
]

for attempt_filters in filter_attempts:
    recommendations = retriever.search(query, filters=attempt_filters, top_k=3)
    if recommendations:
        print(f"✅ Found {len(recommendations)} layouts with filters: {attempt_filters}")
        break
```

---

## 핵심 포인트

| 항목 | 내용 |
|:---|:---|
| **목적** | 검색 실패 방지 |
| **전략** | 조건을 단계별로 완화 |
| **결과** | 검색 성공률 100% |
| **최후 수단** | 의미 유사도만으로 검색 |

---

## 하이브리드 검색 전략 (Semantic + Filter 동시 적용)

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                                                                             │
│                   🔍 Hybrid Search (동시 적용)                              │
│                                                                             │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│   1️⃣ 쿼리 임베딩 생성                                                       │
│   ─────────────────────────────────────────────────────────────────         │
│   query = "Elegant fashion editorial sophisticated luxury"                  │
│                              ↓                                              │
│   Voyage 3.5 → 512차원 벡터                                                 │
│                                                                             │
│   2️⃣ ChromaDB 단일 쿼리 (동시 실행!)                                        │
│   ─────────────────────────────────────────────────────────────────         │
│   ┌───────────────────────────────────────────────────────────────────┐    │
│   │                                                                   │    │
│   │   collection.query(                                               │    │
│   │       query_embeddings = [query_embedding],  ← 시멘틱 유사도     │    │
│   │       where = {                               ← 메타 필터        │    │
│   │           'type': 'Cover',                                        │    │
│   │           'image_count': 3                                        │    │
│   │       }                                                           │    │
│   │   )                                                               │    │
│   │                                                                   │    │
│   └───────────────────────────────────────────────────────────────────┘    │
│                              ↓                                              │
│   3️⃣ 결과: 필터 만족 AND 유사도 높은 순                                      │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

---

## 검색 로직 요약

> **❌ "필터로 거른 후 → 시멘틱 검색" (순차 X)**
> 
> **✅ "필터 + 시멘틱 동시 적용" (병렬 O)**

| 구성 요소 | 역할 | 사용 필드 |
|:---|:---|:---|
| **query_embeddings** | 의미 유사도 계산 | mood, description, keywords |
| **where** | 메타데이터 필터링 | type, image_count, layout_ratio |
| **결과** | 필터 조건 충족 + 유사도 높은 순 정렬 | - |

---

## 필드별 검색 방식

| 필드 | 방식 | 이유 |
|:---|:---:|:---|
| **mood** | 쿼리 | "Elegant" ≈ "Sophisticated" 유사 매칭 |
| **description** | 쿼리 | 자유 텍스트, 의미 유사도 |
| **keywords** | 쿼리 | 다양한 태그 유사 매칭 |
| **category** | 쿼리 | fashion ≈ beauty 유사 매칭 |
| **type** | 필터 | Cover/Article 정확 분류 필요 |
| **image_count** | 필터 | 이미지 개수 정확 일치 필요 |
| **layout_ratio** | 필터 | 가로/세로 정확 일치 필요 |

---

## 쿼리 생성 코드 (main.py)

```python
# 의미 검색용 쿼리 생성
query_parts = [
    analysis.get('mood', ''),           # ✅ mood 포함
    visual_tags,                        # ✅ visual_keywords 포함
    analysis.get('category', ''),       # ✅ category 포함
    analysis.get('type', ''),
    analysis.get('description', '')     # ✅ description 포함
]
query = " ".join([p for p in query_parts if p])

# 메타데이터 필터 생성
full_filters = {
    'type': db_type,                    # Cover/Article
    'image_count': len(page_images),    # 1~7
    'layout_ratio': "Horizontal"        # Horizontal/Vertical/Square
}
```

---

## 왜 이렇게 나눴나?

> **필터 = 구조적 조건** (이미지 3장짜리에 5장 레이아웃 적용 불가)
> 
> **쿼리 = 분위기/스타일** ("Elegant"와 "Luxurious"는 비슷해도 OK)

